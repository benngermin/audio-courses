<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Audio Ended Event</title>
</head>
<body>
    <h1>Audio Ended Event Test</h1>
    <button id="playBtn">Play Audio</button>
    <button id="skipBtn">Skip to End (-5s)</button>
    <div id="status">Status: Ready</div>
    <div id="time">Time: 0 / 0</div>
    <div id="events">Events: </div>

    <script>
        const audio = new Audio('/api/audio/test-chapter.mp3');
        const playBtn = document.getElementById('playBtn');
        const skipBtn = document.getElementById('skipBtn');
        const statusDiv = document.getElementById('status');
        const timeDiv = document.getElementById('time');
        const eventsDiv = document.getElementById('events');
        
        let isPlaying = false;

        audio.addEventListener('loadedmetadata', () => {
            eventsDiv.innerHTML += 'loadedmetadata, ';
            timeDiv.innerHTML = `Time: 0 / ${audio.duration.toFixed(1)}`;
        });

        audio.addEventListener('play', () => {
            eventsDiv.innerHTML += 'play, ';
            statusDiv.innerHTML = 'Status: Playing';
            isPlaying = true;
            playBtn.textContent = 'Pause';
        });

        audio.addEventListener('pause', () => {
            eventsDiv.innerHTML += 'pause, ';
            statusDiv.innerHTML = 'Status: Paused';
            isPlaying = false;
            playBtn.textContent = 'Play Audio';
        });

        audio.addEventListener('ended', () => {
            eventsDiv.innerHTML += '<strong>ENDED!</strong>, ';
            statusDiv.innerHTML = 'Status: Ended';
            isPlaying = false;
            playBtn.textContent = 'Play Audio';
            console.log('Audio ended event fired!');
        });

        audio.addEventListener('timeupdate', () => {
            timeDiv.innerHTML = `Time: ${audio.currentTime.toFixed(1)} / ${audio.duration.toFixed(1)}`;
        });

        playBtn.addEventListener('click', () => {
            if (isPlaying) {
                audio.pause();
            } else {
                audio.play();
            }
        });

        skipBtn.addEventListener('click', () => {
            if (audio.duration) {
                audio.currentTime = audio.duration - 5;
                audio.play();
            }
        });
    </script>
</body>
</html>